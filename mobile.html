<!DOCTYPE html> 
<html> 
	<head> 
	<title>Media Controller (Mobile)</title> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a3/jquery.mobile-1.0a3.min.css" />
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.3.min.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.0a3/jquery.mobile-1.0a3.min.js"></script>
		<script type="text/javascript">
			var manager = "http://ceol.l42.eu/";
			var tapped = false;
			var volume = 0;
			var data = new Object();
			function poll(newdata) {
				if (newdata.hashcode != null) {
					data = newdata;
					$('#next [data-role="content"]').text(data.next.metadata.title);
					setNow(data.now.metadata);
					if (data.isPlaying) $("h1").text("Now Playing");
					else $("h1").text("Paused");
					volume = data.volume;
					$("#vol").animate({top: $(window).height()*(1-volume) + "px"}, 500);
					tapped = false;
				}
				var senddata = new Object();
				senddata.hashcode = data.hashcode;
				$.ajax({
					url: manager+"poll",
					cache: false,
					data: senddata,
					success: poll,
					error: function () {
						// If there's a problem with the server, wait 5 seconds and try again.
						newpoll(poll, 5000);
					},
				});
			}
			function setNow(metadata) {
				var now = $("#now .info").empty();
				$("<span />").text(metadata.title).appendTo(now);
				if (metadata.artist) $("<span />").text(metadata.artist).appendTo(now);
				$("#now img").attr('src', metadata.thumb);
				var links = $("#now .links").empty();
				if (metadata.exturl) $("<li/>").text('exturl').appendTo(links).bind('tap', function() {$.get(manager+"openexturl"); return false;});
				if (metadata.editurl) $("<li/>").text('edit').appendTo(links).bind('tap', function() {$.get(manager+"openediturl"); return false;});
			}
			function newpoll(pollfunc, wait) {
				//if (wait == null) wait = 500;
				setTimeout(function () {pollfunc(new Object());}, wait);
			}
			
			function checkorientation() {
				
				if(window.innerHeight > window.innerWidth){
					$("#now").removeClass("landscape").addClass("portrait");
				} else {
					$("#now").removeClass("portrait").addClass("landscape");
				}
			}
			$(checkorientation);
			$(window).ready(function (){
				$("#vol").css('top', $(window).height() + "px");
				$(window).load(function (){
					newpoll(poll);
				});
				$('body').bind("swiperight", function() {
					$('#next [data-role="content"]').empty();
					setNow(data.next.metadata);
					$.get(manager+'next?', {now: data.now.url});
				}).bind("tap", function(e) {
					if (tapped) return;
					tapped = true;
					if (data.isPlaying) {
						$("h1").text("Pausing...");
						$.get(manager+'pause');
					} else {
						$("h1").text("Unpausing...");
						$.get(manager+'play');
					}
				});
				// include: touchmove touchstart touchend ?
				$('#volcontain').bind("tap", function(e) {
					if (Math.abs($("#vol").offset().top - e.pageY) < ($(window).height() / 20) ) return;
					volume = 1 - (e.pageY/$(window).height());
					$.get(manager+"volume", { volume: volume });
					$("#vol").animate({top: e.pageY + "px"}, 500);
					return false;
				});
				$(window).bind("orientationchange resize", function() {
					$("#vol").css('top', $(window).height()*(1-volume) + "px");
					checkorientation();
				});
			});
		</script>
		<style type="text/css">
			body > div{
				height: 100%;
				overflow: hidden;
			}
			#now {
				text-align: center;
				padding: 0 60px;
			}
			.info span {
				display: block;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			#next {
				bottom: 0;
				position: fixed;
				width: 100%;
			}
			#next [data-role="content"] {
				padding-right: 60px;
			}
			[data-role="content"] {
				overflow: hidden;
			}
			#now img {
				display: block;
				height: 100px;
				margin: 1em auto;
				/*-webkit-box-reflect: below 0 -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(rgba(255, 255, 255, 0.5)), color-stop(0.7, transparent)); */
			}
			#vol {
				position:absolute;
				top: 100%;
				height: 100%;
				width: 100%;
				-webkit-border-radius: 20px;
				background-image:
					-webkit-gradient(linear, 0 0, 100% 0,
						color-stop(0, rgba(0,0,0,0)),
						color-stop(0.15, rgba(0,0,0,0.6)),
						color-stop(0.5, rgba(0,0,0,0)));
				-webkit-box-shadow:0 2px 2px rgba(0,0,0,0.15);
				/*-webkit-transition:top 0.5s ease-out; */
			}
			#vol.adjust {
				-webkit-transition:none; 
				background: red;
				border: solid blue;
			}
			#volcontain {
				height: 100%;
				top: 0;
				right: 0;
				position: fixed;
				width: 50px;
				overflow: hidden
			}
			.links li {
				font-weight: bold;
				text-size: 200%;
				color: yellow;
				line-height: 200%;
			}
			#now.landscape .display{
				width: 65%;
				float:right;
			}
			#now.landscape .links{
				display:inline;
				float:left;
				margin-left:-60px;
			}
		</style>
</head> 
<body> 

<div data-role="page" data-theme='a'>

	<div data-role="header">
		<h1>Loading...</h1>
	</div><!-- /header -->

	<div data-role="content">
		<div id='now'>
			<div class='display'>
				<span class='info'></span>
				<img />
			</div>
			<ul class='links'></ul>
		</div>
	</div><!-- /content -->
	<div id='next'>
		<div data-role="header">
			<h2>Next</h2>
		</div><!-- /header -->
		<div data-role="content">
		</div>
	</div>
	<div id='volcontain'><div id='vol'></div></div>
</div><!-- /page -->

</body>
</html>
